<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="css/style.css"/>
  <title>Watch these minutes fly by...</title>

</head>
<body>
<script src="bower_components/mithril/mithril.min.js"></script>
<script src="bower_components/momentjs/min/moment.min.js"></script>
<script>
  function nextFriday(date) {
    var input, output;
    input = moment(date);
    output = input.clone().startOf('week').day(5).hour(17).minute(0).second(0);
    return output > input ? output : output.add(7, 'days');
  }

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function sample(arr) {
    if (!Array.isArray(arr)) {
      console.error('not an array');
      return false;
    }

    return arr[randomInt(0, arr.length - 1)];
  }

  var timer = {}, intervalId;

  timer.phrases = [
    'a watched kettle never boils',
    'time flies when you\'re having fun.',
    'keep staring: I won\'t go any faster.',
    'tick tock tick tock tick tock',
    'look at those minutes fly by! wait.',
    'it\'s been the same number for a while now.',
    'time does not pass. it continues.',
    'how will you find time to do it over if you don\'t have time to do it right?',
    'the only reason for time is so that everything doesn\'t happen at once.',
    'time flies like an arrow; fruit flies like a banana.',
    'time is the longest distance between two places.',
    'time is an illusion.',
    'you may delay, but time will not.',
    'only time can heal his broken arms and legs.',
    'the strongest of all warriors are these two â€” Time and Patience.',
    'never waste a minute thinking about people you don\'t like.',
    'a man who dares to waste one hour of time has not discovered the value of life.'
  ];

  timer.vm = (function () {
    var vm = {};

    vm.init = function () {
      vm.time = moment();
      vm.endTime = nextFriday(vm.time);
      vm.remaining = m.prop(0);
      vm.phrase = m.prop(sample(timer.phrases));

      vm.getTimeDiff = function () {
        vm.time = moment();
        var remaining = vm.endTime.diff(vm.time, 'minutes');
        vm.remaining(remaining);
        return remaining < 0;
      };
    };

    return vm;
  })();

  timer.view = function () {
    return m('html', [
      m('body', [
        m('div.content', [
          m('div.remaining', 'Minutes until Friday 5pm'),
          m('div.minutes', timer.vm.remaining()),
          m('div.note', timer.vm.phrase())
        ]),
        m('div.credits', [
          m('span', 'for Paul, \u00A9 2015 BHesse')
        ])
      ])
    ]);
  };

  timer.tick = function __updateTick() {
    m.startComputation();
    var finished = timer.vm.getTimeDiff();
    if (finished) {
      timer.vm.endTime = nextFriday(timer.vm.time);
    }
    if (randomInt(0, 9) < 1) {
      timer.vm.phrase(sample(timer.phrases));
    }
    m.endComputation();
  };

  timer.controller = function () {
    timer.vm.init();
    timer.vm.getTimeDiff();
    timer.tick();
  };

  m.mount(document.body, {controller: timer.controller, view: timer.view});
  intervalId = setInterval(timer.tick, 5000);
</script>
</body>