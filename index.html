<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="css/style.css"/>
  <title>Watch these minutes fly by...</title>

</head>
<body>
<script src="bower_components/mithril/mithril.min.js"></script>
<script src="bower_components/q/q.js"></script>
<script src="bower_components/momentjs/min/moment.min.js"></script>
<script src="bower_components/lodash/lodash.min.js"></script>
<script>
  var timeout = (function () {
    function sliceArgs(args, offset) {
      return Array.prototype.slice.call(args, offset);
    }

    var remainingTimeouts = 0;
    var pendingTimeouts = {};
    var deferreds = {};

    function completeOutstandingRequests(fn) {
      try {
        fn.apply(null, sliceArgs(arguments, 1));
      } finally {
        remainingTimeouts -= 1;
      }
    }

    var defer = function (fn, delay) {
      var timeoutId;
      remainingTimeouts += 1;
      timeoutId = setTimeout(function () {
        delete pendingTimeouts[timeoutId];
        completeOutstandingRequests(fn);
      }, delay || 0);
      pendingTimeouts[timeoutId] = true;
      return timeoutId;
    };

    defer.cancel = function (deferId) {
      if (pendingTimeouts[deferId]) {
        delete pendingTimeouts[deferId];
        clearTimeout(deferId);
        completeOutstandingRequests(function () {
        });
        return true;
      }

      return false;
    };

    function timeout(fn, delay) {
      var args = sliceArgs(arguments, 2),
          deferred = Q.defer(),
          promise = deferred.promise,
          timeoutId;

      timeoutId = defer(function () {
        try {
          deferred.resolve(fn.apply(null, args));
        } catch (e) {
          deferred.reject(e);
        } finally {
          delete deferreds[promise.__timeoutId];
        }
      }, delay);

      promise.__timeoutId = timeoutId;
      deferreds[timeoutId] = deferred;

      return promise;
    }

    timeout.cancel = function (promise) {
      if (promise && Object.keys(deferreds).indexOf(promise.__timeoutId) !== -1) {
        deferreds[promise.__timeoutId].reject('canceled');
        delete deferreds[promise.__timeoutId];
        return defer.cancel(promise.__timeoutId);
      }

      return false;
    };

    return timeout;
  })();

  function nextFriday(date) {
    var input, output;
    input = moment(date);
    output = input.clone().startOf('week').day(5).hour(17).minute(0).second(0);
    return output > input ? output : output.add(7, 'days');
  }

  var timer = {};

  timer.Timer = function (data) {
    this.endTime = m.prop(data.endTime);
  };

  timer.phrases = [
    'a watched kettle never boils',
    'time flies when you\'re having fun.',
    'keep staring: I won\'t go any faster.',
    'tick tock tick tock tick tock',
    'look at those minutes fly by! wait.',
    'it\'s been the same number for a while now.',
    'time does not pass. it continues.',
    'how will you find time to do it over if you don\'t have time to do it right?',
    'the only reason for time is so that everything doesn\'t happen at once.',
    'time flies like an arrow; fruit flies like a banana.',
    'time is the longest distance between two places.',
    'time is an illusion.',
    'you may delay, but time will not.',
    'only time can heal his broken arms and legs.',
    'the strongest of all warriors are these two â€” Time and Patience.',
    'never waste a minute thinking about people you don\'t like.',
    'a man who dares to waste one hour of time has not discovered the value of life.'
  ];

  timer.vm = (function () {
    var vm = {};

    vm.init = function () {
      vm.time = moment();
      vm.endTime = nextFriday(vm.time);
      vm.remaining = m.prop(0);
      vm.phrase = m.prop(_.sample(timer.phrases));

      vm.getTimeDiff = function () {
        vm.time = moment();
        var remaining = vm.endTime.diff(vm.time, 'minutes');
        vm.remaining(remaining);
        return remaining < 0;
      };
    };

    return vm;
  })();

  timer.view = function () {
    return m('html', [
      m('body', [
        m('div.content', [
          m('div.remaining', 'Minutes until Friday 5pm'),
          m('div.minutes', timer.vm.remaining()),
          m('div.note', timer.vm.phrase())
        ]),
        m('div.credits', [
          m('span', 'for Paul, \u00A9 2015 BHesse')
        ])
      ])
    ]);
  };

  timer.tick = function __updateTick() {
    m.startComputation();
    timeout(function __timeout() {
      var finished = timer.vm.getTimeDiff();
      if (finished) {
        timer.vm.endTime = nextFriday(timer.vm.time);
      }
      if (_.random(1, 10) < 2) {
        timer.vm.phrase(_.sample(timer.phrases));
      }
      m.endComputation();
      timer.tick();
    }, 4000);
  };

  timer.controller = function () {
    timer.vm.init();
    timer.vm.getTimeDiff();
  };

  m.mount(document.body, {controller: timer.controller, view: timer.view});
  timeout(function () {
    timer.tick();
  });
</script>
</body>